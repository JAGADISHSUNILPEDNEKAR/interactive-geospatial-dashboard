name: CI/CD Pipeline

on:
  push:
    branches: [main, develop, staging]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
          - dev
          - staging
          - production

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY_PREFIX: enterprise-saas
  TERRAFORM_VERSION: 1.5.0
  KUBECTL_VERSION: 1.27.0
  HELM_VERSION: 3.12.0

jobs:
  # Code Quality & Security Scanning
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [
          user-management,
          inventory-management,
          financial-analytics,
          document-management,
          communication-hub,
          audit-logging,
          workflow-engine,
          reporting-service,
          notification-service,
          integration-hub
        ]
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        if: contains(fromJson('["user-management", "financial-analytics"]'), matrix.service)
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Set up Java
        if: contains(fromJson('["inventory-management", "integration-hub"]'), matrix.service)
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
      
      - name: Set up .NET
        if: matrix.service == 'document-management'
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '7.0.x'
      
      - name: Set up Ruby
        if: matrix.service == 'workflow-engine'
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.1'
      
      - name: Set up PHP
        if: contains(fromJson('["reporting-service", "notification-service"]'), matrix.service)
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
      
      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/pip
            ~/.m2
            ~/.nuget/packages
            ~/.bundle
            ~/.composer
          key: ${{ runner.os }}-${{ matrix.service }}-${{ hashFiles('**/requirements.txt', '**/pom.xml', '**/*.csproj', '**/Gemfile.lock', '**/composer.lock') }}
      
      - name: Install dependencies
        working-directory: services/${{ matrix.service }}
        run: |
          case "${{ matrix.service }}" in
            user-management|financial-analytics)
              pip install -r requirements.txt
              pip install flake8 black mypy pytest-cov
              ;;
            inventory-management|integration-hub)
              mvn dependency:resolve
              ;;
            document-management)
              dotnet restore
              ;;
            workflow-engine)
              bundle install
              ;;
            reporting-service|notification-service)
              composer install
              ;;
          esac
      
      - name: Run linting
        working-directory: services/${{ matrix.service }}
        run: |
          case "${{ matrix.service }}" in
            user-management|financial-analytics)
              flake8 . --config=.flake8
              black --check .
              mypy .
              ;;
            inventory-management|integration-hub)
              mvn checkstyle:check
              ;;
            document-management)
              dotnet format --verify-no-changes
              ;;
            workflow-engine)
              bundle exec rubocop
              ;;
            reporting-service|notification-service)
              ./vendor/bin/phpcs
              ;;
          esac
      
      - name: Security scanning
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: 'services/${{ matrix.service }}'
          format: 'sarif'
          output: 'trivy-results.sarif'
      
      - name: Upload security results
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-results.sarif'

  # Unit Tests
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: code-quality
    strategy:
      matrix:
        service: [
          user-management,
          inventory-management,
          financial-analytics,
          document-management,
          workflow-engine,
          reporting-service
        ]
    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
        ports:
          - 3306:3306
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup test environment
        run: |
          echo "Setting up test databases..."
          case "${{ matrix.service }}" in
            user-management|financial-analytics|workflow-engine)
              PGPASSWORD=postgres psql -h localhost -U postgres -c "CREATE DATABASE test_${{ matrix.service }};"
              ;;
            inventory-management|reporting-service)
              mysql -h 127.0.0.1 -uroot -proot -e "CREATE DATABASE test_${{ matrix.service }};"
              ;;
          esac
      
      - name: Run unit tests
        working-directory: services/${{ matrix.service }}
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost/test_${{ matrix.service }}
          REDIS_URL: redis://localhost:6379
        run: |
          case "${{ matrix.service }}" in
            user-management|financial-analytics)
              pytest --cov=. --cov-report=xml --cov-report=html
              ;;
            inventory-management)
              mvn test
              ;;
            document-management)
              dotnet test --collect:"XPlat Code Coverage"
              ;;
            workflow-engine)
              bundle exec rspec
              ;;
            reporting-service)
              ./vendor/bin/phpunit
              ;;
          esac
      
      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: ${{ matrix.service }}
          name: ${{ matrix.service }}-coverage

  # Build Docker Images
  build-images:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: unit-tests
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    strategy:
      matrix:
        service: [
          user-management,
          inventory-management,
          financial-analytics,
          document-management,
          communication-hub,
          audit-logging,
          workflow-engine,
          reporting-service,
          notification-service,
          integration-hub
        ]
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: services/${{ matrix.service }}
          push: true
          tags: |
            ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY_PREFIX }}-${{ matrix.service }}:${{ github.sha }}
            ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY_PREFIX }}-${{ matrix.service }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            VERSION=${{ github.sha }}
            BUILD_DATE=${{ github.event.head_commit.timestamp }}

  # Integration Tests
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: build-images
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Compose
        run: |
          docker-compose -f docker-compose.test.yml up -d
          sleep 30  # Wait for services to be ready
      
      - name: Run integration tests
        run: |
          cd tests/integration
          npm install
          npm run test:api
          npm run test:workflow
      
      - name: Collect logs on failure
        if: failure()
        run: |
          docker-compose -f docker-compose.test.yml logs > integration-test-logs.txt
      
      - name: Upload logs
        if: failure()
        uses: actions/upload-artifact@v3
        with:
          name: integration-test-logs
          path: integration-test-logs.txt
      
      - name: Cleanup
        if: always()
        run: docker-compose -f docker-compose.test.yml down -v

  # Deploy to Environment
  deploy:
    name: Deploy to ${{ github.event.inputs.environment || 'staging' }}
    runs-on: ubuntu-latest
    needs: [integration-tests]
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    environment:
      name: ${{ github.event.inputs.environment || 'staging' }}
      url: https://${{ github.event.inputs.environment || 'staging' }}.enterprise-saas.com
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
      
      - name: Terraform Init
        working-directory: infrastructure/terraform
        run: |
          terraform init -backend-config="key=${{ github.event.inputs.environment || 'staging' }}/terraform.tfstate"
      
      - name: Terraform Plan
        working-directory: infrastructure/terraform
        run: |
          terraform plan \
            -var-file=environments/${{ github.event.inputs.environment || 'staging' }}/terraform.tfvars \
            -out=tfplan
      
      - name: Terraform Apply
        working-directory: infrastructure/terraform
        if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
        run: |
          terraform apply -auto-approve tfplan
      
      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig \
            --region ${{ env.AWS_REGION }} \
            --name ${{ github.event.inputs.environment || 'staging' }}-saas-cluster
      
      - name: Deploy to Kubernetes
        run: |
          # Set environment variables
          export ENVIRONMENT=${{ github.event.inputs.environment || 'staging' }}
          export VERSION=${{ github.sha }}
          export ECR_REGISTRY=${{ steps.login-ecr.outputs.registry }}
          
          # Apply configurations
          envsubst < infrastructure/kubernetes/namespaces/namespaces.yaml | kubectl apply -f -
          envsubst < infrastructure/kubernetes/configmaps/global-config.yaml | kubectl apply -f -
          envsubst < infrastructure/kubernetes/secrets/sealed-secrets.yaml | kubectl apply -f -
          
          # Deploy services
          for service in user-management inventory-management financial-analytics document-management communication-hub audit-logging workflow-engine reporting-service notification-service integration-hub; do
            envsubst < infrastructure/kubernetes/deployments/${service}-deployment.yaml | kubectl apply -f -
            kubectl rollout status deployment/${service} -n saas-platform --timeout=300s
          done
      
      - name: Run smoke tests
        run: |
          cd tests/smoke
          npm install
          npm run test:${{ github.event.inputs.environment || 'staging' }}
      
      - name: Update deployment status
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: context.payload.deployment.id,
              state: '${{ job.status }}',
              environment_url: 'https://${{ github.event.inputs.environment || 'staging' }}.enterprise-saas.com',
              description: 'Deployment ${{ job.status }}'
            })

  # Performance Tests
  performance-tests:
    name: Performance Tests
    runs-on: ubuntu-latest
    needs: deploy
    if: github.event.inputs.environment == 'staging' || github.ref == 'refs/heads/main'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install K6
        run: |
          sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6
      
      - name: Run load tests
        run: |
          export TARGET_URL=https://${{ github.event.inputs.environment || 'staging' }}.enterprise-saas.com
          k6 run tests/load/k6-scripts/baseline.js
          k6 run tests/load/k6-scripts/stress.js
          k6 run tests/load/k6-scripts/spike.js
      
      - name: Upload results
        uses: actions/upload-artifact@v3
        with:
          name: performance-test-results
          path: tests/load/results/

  # Security Scanning
  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    needs: deploy
    if: github.event.inputs.environment == 'staging' || github.ref == 'refs/heads/main'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: OWASP ZAP Scan
        uses: zaproxy/action-full-scan@v0.7.0
        with:
          target: 'https://${{ github.event.inputs.environment || 'staging' }}.enterprise-saas.com'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a'
      
      - name: Upload ZAP results
        uses: actions/upload-artifact@v3
        with:
          name: zap-scan-results
          path: report_html.html

# Notification on completion
  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: [deploy, performance-tests, security-scan]
    if: always()
    
    steps:
      - name: Send Slack notification
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: |
            Deployment to ${{ github.event.inputs.environment || 'staging' }} ${{ job.status }}
            Commit: ${{ github.sha }}
            Author: ${{ github.actor }}
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
      
      - name: Send email notification
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: Deployment Failed - ${{ github.event.inputs.environment || 'staging' }}
          to: devops@enterprise-saas.com
          from: GitHub Actions
          body: |
            Deployment to ${{ github.event.inputs.environment || 'staging' }} failed.
            
            Repository: ${{ github.repository }}
            Commit: ${{ github.sha }}
            Author: ${{ github.actor }}
            
            Check the workflow run for details:
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}